@using Werewolves.Core.StateModels.Enums
@using Werewolves.Core.StateModels.Models.Instructions
@inject GameClientManager GameClient
@inject IconMap IconMap
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Small">
    <MudText Typo="Typo.h6" GutterBottom="true">Assign Roles</MudText>
    <MudText Typo="Typo.body2" Class="mb-4">Assign a role to each player. Inventory must match.</MudText>

    <MudGrid>
        @foreach (var player in Instruction.PlayersForAssignment)
        {
            <MudItem xs="12" sm="6">
                <MudSelect T="MainRoleType" Label="@GameClient.ActiveSession!.GetPlayer(player).Name" @bind-Value="_assignments[player]" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                    @foreach (var role in Instruction.RolesForAssignment.Distinct())
                    {
                        <MudSelectItem Value="@role">@role</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
        }
    </MudGrid>

    <MudPaper Class="pa-4 mt-4" Elevation="0" Outlined="true">
        <MudText Typo="Typo.subtitle2">Inventory</MudText>
        <MudChipSet T="string" ReadOnly="true">
            @foreach (var roleGroup in Instruction.RolesForAssignment.GroupBy(r => r))
            {
                var assignedCount = _assignments.Values.Count(r => r == roleGroup.Key);
                var totalCount = roleGroup.Count();
                var color = assignedCount == totalCount ? Color.Success : Color.Error;
                <MudChip Text="@($"{roleGroup.Key}: {assignedCount}/{totalCount}")" Color="@color" />
            }
        </MudChipSet>

        @{
            var deltas = GetRoleDeltas().ToList();
        }
        @if (deltas.Any())
        {
            <MudDivider Class="my-2" />
            <MudText Typo="Typo.subtitle2" Class="mb-1">Adjustments Needed</MudText>
            @foreach (var delta in deltas)
            {
                <MudText Typo="Typo.body2" Color="@delta.Color">@delta.Message</MudText>
            }
        }
        else
        {
            <MudDivider Class="my-2" />
            <MudText Typo="Typo.body2" Color="Color.Success">âœ“ All roles correctly assigned</MudText>
        }
    </MudPaper>

    <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" Class="mt-4" OnClick="SubmitRoles" Disabled="@(!IsValid)">
        Submit Roles
    </MudButton>
</MudContainer>

@code {
    [Parameter, EditorRequired] public AssignRolesInstruction Instruction { get; set; } = default!;
    
    private Dictionary<Guid, MainRoleType> _assignments = new();

    protected override void OnInitialized()
    {
    }

    private bool IsValid
    {
        get
        {
            try
            {
                Instruction.CreateResponse(_assignments);
                return true;
            }
            catch (ArgumentException)
            {
                return false;
            }
        }
    }

    private async Task SubmitRoles()
    {
        var response = Instruction.CreateResponse(_assignments);
        await GameClient.ProcessInputAsync(response);
    }

    private IEnumerable<(string Message, Color Color)> GetRoleDeltas()
    {
        var roleGroups = Instruction.RolesForAssignment.GroupBy(r => r);
        
        foreach (var roleGroup in roleGroups)
        {
            var role = roleGroup.Key;
            var required = roleGroup.Count();
            var assigned = _assignments.Values.Count(r => r == role);
            var diff = required - assigned;
            
            if (diff > 0)
            {
                var plural = diff == 1 ? "" : "s";
                yield return ($"Need {diff} more {role}{plural}", Color.Warning);
            }
            else if (diff < 0)
            {
                var excess = Math.Abs(diff);
                var plural = excess == 1 ? "" : "s";
                yield return ($"Remove {excess} {role}{plural}", Color.Error);
            }
        }
    }
}
