@using Werewolves.Core.StateModels.Core
@using Werewolves.Core.StateModels.Models.Instructions
@inject GameClientManager GameClient

<MudContainer MaxWidth="MaxWidth.Small">
    <MudText Typo="Typo.h6" GutterBottom="true">Select Players</MudText>
    <MudText Typo="Typo.body2" Class="mb-4">
        @GetSelectionHint()
    </MudText>

    <MudStack Spacing="2">
        @foreach (var player in GetSelectablePlayers())
        {
            <MudCheckBox T="bool" 
                         Value="@IsPlayerSelected(player.Id)"
                         ValueChanged="@((bool value) => OnPlayerSelectionChanged(player.Id, value))"
                         Label="@player.Name"
                         Color="Color.Primary" />
        }
    </MudStack>

    <MudButton Variant="Variant.Filled" 
               Color="Color.Primary" 
               FullWidth="true" 
               Class="mt-4" 
               OnClick="SubmitSelectionAsync" 
               Disabled="@(!IsValidSelection)">
        Confirm Selection (@GetSelectedCount()/@GetRequiredCountText())
    </MudButton>
</MudContainer>

@code {
    [Parameter] public SelectPlayersInstruction Instruction { get; set; } = null!;

    private Dictionary<Guid, bool> _selectedPlayers = new();

    protected override void OnParametersSet()
    {
        // Initialize selection state for each selectable player
        _selectedPlayers = Instruction.SelectablePlayerIds
            .ToDictionary(id => id, id => false);
    }

    private IEnumerable<IPlayer> GetSelectablePlayers()
    {
        return GameClient.PlayerData?
            .Where(p => Instruction.SelectablePlayerIds.Contains(p.Id))
            ?? Enumerable.Empty<IPlayer>();
    }

    private bool IsPlayerSelected(Guid playerId)
    {
        return _selectedPlayers.TryGetValue(playerId, out var selected) && selected;
    }

    private void OnPlayerSelectionChanged(Guid playerId, bool isSelected)
    {
        _selectedPlayers[playerId] = isSelected;
    }

    private HashSet<Guid> GetSelectedIds()
    {
        return _selectedPlayers
            .Where(kv => kv.Value)
            .Select(kv => kv.Key)
            .ToHashSet();
    }

    private int GetSelectedCount() => _selectedPlayers.Count(kv => kv.Value);

    private bool IsValidSelection => Instruction.CountConstraint.IsValid(GetSelectedIds());

    private string GetRequiredCountText()
    {
        var constraint = Instruction.CountConstraint;
        if (constraint.Minimum == constraint.Maximum)
        {
            return constraint.IsOptional ? $"0 or {constraint.Minimum}" : constraint.Minimum.ToString();
        }
        return constraint.IsOptional 
            ? $"0 or {constraint.Minimum}-{constraint.Maximum}" 
            : $"{constraint.Minimum}-{constraint.Maximum}";
    }

    private string GetSelectionHint()
    {
        var constraint = Instruction.CountConstraint;
        if (constraint.IsOptional && constraint.Minimum == 1 && constraint.Maximum == 1)
        {
            return "Select one player, or skip this action.";
        }
        if (constraint.Minimum == 1 && constraint.Maximum == 1)
        {
            return "Select exactly one player.";
        }
        if (constraint.IsOptional)
        {
            return $"Select {constraint.Minimum} to {constraint.Maximum} players, or skip this action.";
        }
        return $"Select {constraint.Minimum} to {constraint.Maximum} players.";
    }

    private async Task SubmitSelectionAsync()
    {
        var selectedIds = GetSelectedIds();
        var response = Instruction.CreateResponse(selectedIds);
        await GameClient.ProcessInputAsync(response);
    }
}
