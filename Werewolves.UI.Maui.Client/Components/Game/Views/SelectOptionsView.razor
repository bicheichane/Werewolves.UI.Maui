@using Werewolves.Core.StateModels.Models.Instructions
@inject GameClientManager GameClient

<MudContainer MaxWidth="MaxWidth.Small">
    <MudText Typo="Typo.h6" GutterBottom="true">Select Option(s)</MudText>
    
    @if (IsSingleSelect)
    {
        <MudRadioGroup T="string" @bind-Value="_selectedSingle">
            @foreach (var option in Instruction.SelectableOptions)
            {
                <MudRadio Value="@option" Color="Color.Primary">@option</MudRadio>
            }
        </MudRadioGroup>
    }
    else
    {
        @foreach (var option in Instruction.SelectableOptions)
        {
            <MudCheckBox T="bool" Value="@_selectedMulti.GetValueOrDefault(option)" 
                         ValueChanged="@(value => OnCheckboxChanged(option, value))" 
                         Label="@option" Color="Color.Primary" />
        }
    }

    <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" Class="mt-4" 
               OnClick="SubmitOption" Disabled="@(!IsValidSelection)">
        Confirm Selection
    </MudButton>
</MudContainer>

@code {
    [Parameter] public SelectOptionsInstruction Instruction { get; set; } = null!;

    private string? _selectedSingle;
    private Dictionary<string, bool> _selectedMulti = new();

    // Single select if range is exactly 1-1
    private bool IsSingleSelect =>
        Instruction.SelectionRange.Minimum == 1 &&
        Instruction.SelectionRange.Maximum == 1;

    protected override void OnParametersSet()
    {
        _selectedMulti = Instruction.SelectableOptions
            .ToDictionary(o => o, o => false);
    }

    private void OnCheckboxChanged(string option, bool value)
    {
        _selectedMulti[option] = value;
    }

    private HashSet<string> GetSelectedOptions()
    {
        if (IsSingleSelect)
            return _selectedSingle != null ? new() { _selectedSingle } : new();
        return _selectedMulti.Where(kv => kv.Value).Select(kv => kv.Key).ToHashSet();
    }

    private bool IsValidSelection =>
        Instruction.SelectionRange.IsValid(GetSelectedOptions());

    private async Task SubmitOption()
    {
        var response = Instruction.CreateResponse(GetSelectedOptions());
        await GameClient.ProcessInputAsync(response);
    }
}
