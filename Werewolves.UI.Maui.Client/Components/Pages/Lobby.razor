@page "/"
@implements IDisposable
@using Microsoft.AspNetCore.Components.Web
@using Werewolves.Core.StateModels.Enums
@using Werewolves.Core.StateModels.Extensions
@using Werewolves.Core.StateModels.Models
@inject GameClientManager GameClient
@inject IconMap IconMap
@inject ISnackbar Snackbar
@inject NavigationManager NavManager

<MudContainer MaxWidth="MaxWidth.Medium" Class="pa-4">
    <MudText Typo="Typo.h4" GutterBottom="true">Game Setup</MudText>

    <MudStepper @ref="_stepper" Linear="true" Class="mud-width-full">
        <!-- Step 1: Players -->
        <MudStep Title="Players" Icon="@Icons.Material.Filled.People">
            <MudPaper Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">Players (@_players.Count)</MudText>
                    
                    <MudStack Row="true" Class="mb-4">
                        <MudTextField @bind-Value="_newPlayerName" 
                                      Label="Player Name" 
                                      Variant="Variant.Outlined" 
                                      Margin="Margin.Dense"
                                      OnKeyDown="HandlePlayerKeyDown" />
                        <MudButton Variant="Variant.Filled" 
                                   Color="Color.Primary" 
                                   OnClick="AddPlayer" 
                                   Disabled="@string.IsNullOrWhiteSpace(_newPlayerName)">
                            Add
                        </MudButton>
                    </MudStack>

                    @foreach (var error in _playerErrors)
                    {
                        <MudAlert Severity="Severity.Error" Class="mb-2">@error.Message</MudAlert>
                    }

                    <MudList T="string" Dense="true" Style="max-height: 300px; overflow-y: auto;">
                        @for (int i = 0; i < _players.Count; i++)
                        {
                            var index = i;
                            var player = _players[i];
                            <MudListItem Dense="true">
                                <div class="d-flex align-center justify-space-between" style="width: 100%;">
                                    <MudText>@player</MudText>
                                    <div>
                                        <MudIconButton Icon="@Icons.Material.Filled.ArrowUpward" 
                                                       Size="Size.Small" 
                                                       OnClick="@(() => MoveUp(index))" 
                                                       Disabled="@(index == 0)" />
                                        <MudIconButton Icon="@Icons.Material.Filled.ArrowDownward" 
                                                       Size="Size.Small" 
                                                       OnClick="@(() => MoveDown(index))" 
                                                       Disabled="@(index == _players.Count - 1)" />
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                       Size="Size.Small" 
                                                       Color="Color.Error" 
                                                       OnClick="@(() => RemovePlayer(player))" />
                                    </div>
                                </div>
                            </MudListItem>
                        }
                    </MudList>
            </MudPaper>
        </MudStep>

        <!-- Step 2: Roles -->
        <MudStep Title="Roles" Icon="@Icons.Material.Filled.TheaterComedy">
            <MudPaper Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-2">
                        Roles: @_roleCounts.Values.Sum() / Expected: @GetExpectedRoleCount()
                    </MudText>

                    @foreach (var error in GetRoleErrors())
                    {
                        <MudAlert Severity="Severity.Error" Class="mb-2">@error.Message</MudAlert>
                    }

                    <div style="max-height: 400px; overflow-y: auto;">
                        @foreach (var group in Enum.GetValues<RoleGroup>())
                        {
                            var rolesInGroup = GetRolesByGroup(group);
                            if (rolesInGroup.Any())
                            {
                                <MudText Typo="Typo.subtitle1" Class="mt-3 mb-2" Color="Color.Primary">
                                    @GetGroupDisplayName(group)
                                </MudText>
                                
                                @foreach (var role in rolesInGroup)
                                {
                                    var constraint = GameSessionConfig.RoleCountConstraints[role];
                                    var count = GetRoleCount(role);
                                    var isAtLeast = !constraint.IsOptional && constraint.Maximum == int.MaxValue;
                                    var isExactOptional = constraint.IsOptional && constraint.Minimum == constraint.Maximum;

                                    <div class="d-flex align-center justify-space-between py-1" style="width: 100%;">
                                        <div class="d-flex align-center">
                                            <MudAvatar Size="Size.Small" Image="@IconMap.GetIcon(role)" Class="mr-2" />
                                            <MudText>@role</MudText>
                                            @if (isExactOptional && constraint.Minimum > 1)
                                            {
                                                <MudChip T="string" Size="Size.Small" Color="Color.Info" Class="ml-2">
                                                    +@constraint.Minimum roles
                                                </MudChip>
                                            }
                                        </div>

                                        @if (isAtLeast)
                                        {
                                            <!-- AtLeast(1) - use +/- buttons, disable "-" at minimum -->
                                            <div class="d-flex align-center">
                                                <MudIconButton Icon="@Icons.Material.Filled.Remove" 
                                                               Size="Size.Small" 
                                                               OnClick="@(() => SetRoleCount(role, count - 1))" 
                                                               Disabled="@(count <= constraint.Minimum)" />
                                                <MudText Class="mx-2" Style="min-width: 24px; text-align: center;">@count</MudText>
                                                <MudIconButton Icon="@Icons.Material.Filled.Add" 
                                                               Size="Size.Small" 
                                                               OnClick="@(() => SetRoleCount(role, count + 1))" />
                                            </div>
                                        }
                                        else if (isExactOptional)
                                        {
                                            <!-- SingleOptional or ExactOptional - use checkbox -->
                                            <MudCheckBox T="bool" 
                                                         Value="@(count > 0)" 
                                                         ValueChanged="@((bool val) => ToggleRole(role))" 
                                                         Color="Color.Primary" />
                                        }
                                        else
                                        {
                                            <!-- Default: +/- buttons -->
                                            <div class="d-flex align-center">
                                                <MudIconButton Icon="@Icons.Material.Filled.Remove" 
                                                               Size="Size.Small" 
                                                               OnClick="@(() => SetRoleCount(role, count - 1))" 
                                                               Disabled="@(count == 0)" />
                                                <MudText Class="mx-2" Style="min-width: 24px; text-align: center;">@count</MudText>
                                                <MudIconButton Icon="@Icons.Material.Filled.Add" 
                                                               Size="Size.Small" 
                                                               OnClick="@(() => SetRoleCount(role, count + 1))" />
                                            </div>
                                        }
                                    </div>
                                }
                            }
                        }
                    </div>
            </MudPaper>
        </MudStep>

        <!-- Step 3: Summary -->
        <MudStep Title="Summary" Icon="@Icons.Material.Filled.Checklist">
            <MudPaper Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">Game Summary</MudText>
                    
                    <MudText Typo="Typo.subtitle1" Class="mb-2">
                        @_players.Count Players, @_roleCounts.Values.Sum() Roles
                    </MudText>

                    <MudDivider Class="my-3" />

                    <MudText Typo="Typo.subtitle2" Color="Color.Primary" Class="mb-2">Players</MudText>
                    <MudStack Row="true" Wrap="Wrap.Wrap" Spacing="1" Class="mb-4">
                        @foreach (var player in _players)
                        {
                            <MudChip T="string" Size="Size.Small">@player</MudChip>
                        }
                    </MudStack>

                    <MudDivider Class="my-3" />

                    <MudText Typo="Typo.subtitle2" Color="Color.Primary" Class="mb-2">Roles</MudText>
                    @foreach (var group in Enum.GetValues<RoleGroup>())
                    {
                        var rolesInGroup = GetRolesByGroup(group).Where(r => GetRoleCount(r) > 0).ToList();
                        if (rolesInGroup.Any())
                        {
                            <MudText Typo="Typo.caption" Class="mt-2">@GetGroupDisplayName(group)</MudText>
                            <MudStack Row="true" Wrap="Wrap.Wrap" Spacing="1" Class="mb-2">
                                @foreach (var role in rolesInGroup)
                                {
                                    var count = GetRoleCount(role);
                                    <MudChip T="string" Size="Size.Small">
                                        @role @(count > 1 ? $"Ã—{count}" : "")
                                    </MudChip>
                                }
                            </MudStack>
                        }
                    }

                    <MudDivider Class="my-4" />

                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Success" 
                               Size="Size.Large" 
                               FullWidth="true" 
                               OnClick="StartGame"
                               Disabled="@HasAnyErrors">
                        Start Game
                    </MudButton>
            </MudPaper>
        </MudStep>
    </MudStepper>
</MudContainer>

@code {
    private MudStepper _stepper = null!;
    private List<string> _players = new();
    private string _newPlayerName = string.Empty;
    private Dictionary<MainRoleType, int> _roleCounts = new();
    private List<GameConfigValidationError> _playerErrors = new();
    private List<GameConfigValidationError> _configErrors = new();

    private bool HasAnyErrors => _playerErrors.Any() || _configErrors.Any();

    protected override void OnInitialized()
    {
        // Enable Wake Lock when entering Lobby
        DeviceDisplay.Current.KeepScreenOn = true;
        
        ValidatePlayers();
        ValidateConfig();
    }

    public void Dispose()
    {
        // Only disable Wake Lock if game wasn't started (navigating away without starting)
        if (GameClient.ActiveSession == null)
        {
            DeviceDisplay.Current.KeepScreenOn = false;
        }
    }

    private void HandlePlayerKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(_newPlayerName))
        {
            AddPlayer();
        }
    }

    private void AddPlayer()
    {
        if (!string.IsNullOrWhiteSpace(_newPlayerName))
        {
            _players.Add(_newPlayerName.Trim());
            _newPlayerName = string.Empty;
            ValidatePlayers();
            ValidateConfig();
        }
    }

    private void RemovePlayer(string name)
    {
        _players.Remove(name);
        ValidatePlayers();
        ValidateConfig();
    }

    private void MoveUp(int index)
    {
        if (index > 0)
        {
            var item = _players[index];
            _players.RemoveAt(index);
            _players.Insert(index - 1, item);
        }
    }

    private void MoveDown(int index)
    {
        if (index < _players.Count - 1)
        {
            var item = _players[index];
            _players.RemoveAt(index);
            _players.Insert(index + 1, item);
        }
    }

    private void ValidatePlayers()
    {
        GameSessionConfig.TryGetPlayerConfigIssues(_players, out var issues);
        _playerErrors = issues ?? new List<GameConfigValidationError>();
    }

    private void ValidateConfig()
    {
        var roleList = BuildRoleList();
        GameSessionConfig.TryGetConfigIssues(_players, roleList, out var issues);
        _configErrors = issues ?? new List<GameConfigValidationError>();
    }

    private List<GameConfigValidationError> GetRoleErrors()
    {
        // Filter to only role-related errors for Step 2 display
        var roleErrorTypes = new HashSet<GameConfigValidationErrorType>
        {
            GameConfigValidationErrorType.TooFewRoles,
            GameConfigValidationErrorType.TooManyRoles,
            GameConfigValidationErrorType.RoleCountMismatch,
            GameConfigValidationErrorType.MissingExtraActorRoles,
            GameConfigValidationErrorType.MissingExtraThiefRoles,
            GameConfigValidationErrorType.MissingExtraThiefActorRoles
        };

        return _configErrors.Where(e => roleErrorTypes.Contains(e.Type)).ToList();
    }

    private int GetRoleCount(MainRoleType role)
    {
        return _roleCounts.TryGetValue(role, out var count) ? count : 0;
    }

    private void SetRoleCount(MainRoleType role, int count)
    {
        if (count <= 0)
        {
            _roleCounts.Remove(role);
        }
        else
        {
            _roleCounts[role] = count;
        }
        ValidateConfig();
    }

    private void ToggleRole(MainRoleType role)
    {
        var constraint = GameSessionConfig.RoleCountConstraints[role];
        var currentCount = GetRoleCount(role);

        if (currentCount > 0)
        {
            // Turn off
            _roleCounts.Remove(role);
        }
        else
        {
            // Turn on with the constraint's minimum value
            _roleCounts[role] = constraint.Minimum;
        }
        ValidateConfig();
    }

    private List<MainRoleType> BuildRoleList()
    {
        var roleList = new List<MainRoleType>();
        foreach (var kvp in _roleCounts)
        {
            for (int i = 0; i < kvp.Value; i++)
            {
                roleList.Add(kvp.Key);
            }
        }
        return roleList;
    }

    private int GetExpectedRoleCount()
    {
        var roleList = BuildRoleList();
        return GameSessionConfig.GetExpectedRoleCount(_players.Count, roleList);
    }

    private IEnumerable<MainRoleType> GetRolesByGroup(RoleGroup group)
    {
        return Enum.GetValues<MainRoleType>()
            .Where(role => role.GetRoleGroup() == group)
            .OrderBy(role => role.ToString());
    }

    private string GetGroupDisplayName(RoleGroup group) => group switch
    {
        RoleGroup.Werewolves => "ðŸº Werewolves",
        RoleGroup.Villagers => "ðŸ˜ï¸ Villagers",
        RoleGroup.Ambiguous => "â“ Ambiguous",
        RoleGroup.Loners => "ðŸŽ­ Loners",
        RoleGroup.NewMoon => "ðŸŒ™ New Moon",
        _ => group.ToString()
    };

    private async Task StartGame()
    {
        try
        {
            var roleList = BuildRoleList();
            var config = new GameSessionConfig(_players, roleList);
            await GameClient.StartGameAsync(config);
            NavManager.NavigateTo("/dashboard");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to start game: {ex.Message}", Severity.Error);
        }
    }
}
